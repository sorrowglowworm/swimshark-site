<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>SwimShark Local Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --primary:#2563eb; --bg:#f7fafc; --card:#ffffff; --text:#1f2937; --muted:#6b7280; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{position:sticky;top:0;background:#0b1220;color:#fff;padding:14px 18px;display:flex;align-items:center;gap:10px;z-index:5}
    header .brand{font-weight:700;letter-spacing:.3px}
    header .tip{opacity:.85;font-size:14px}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:18px;}
    .grid{display:grid;gap:16px}
    .grid-cols-2{grid-template-columns:1fr 1fr}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:14px;color:var(--muted)}
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font-size:14px;outline:none}
    textarea{min-height:420px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;line-height:1.45;white-space:pre;overflow:auto}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-ghost{background:#eef2ff;color:#1e3a8a}
    .btn-danger{background:#fee2e2;color:#991b1b}
    .muted{color:var(--muted);font-size:13px}
    .tabs{display:flex;gap:8px;margin:4px 0 14px}
    .tab{padding:10px 14px;border-radius:999px;background:#eef2ff;color:#1e3a8a;cursor:pointer;font-weight:600}
    .tab.active{background:#1e3a8a;color:#fff}
    .hidden{display:none}
    .badge{display:inline-block;background:#f1f5f9;color:#0f172a;border-radius:999px;padding:2px 10px;font-size:12px}
    .hr{height:1px;background:#e5e7eb;margin:14px 0}
    .note{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:12px;padding:10px 12px;color:#334155}
    .login-wrap{max-width:420px;margin:80px auto}
    .center{text-align:center}
    code{background:#f3f4f6;border-radius:6px;padding:1px 6px}
  </style>
</head>
<body>
  <header>
    <div class="brand">ğŸ– SwimShark Local Admin</div>
    <div class="tip">ï¼ˆå… GitHub ç™»å½•çš„æœ¬åœ°ç®¡ç†é¢æ¿ï¼‰</div>
  </header>

  <div class="container">
    <!-- ç™»å½•å¡ç‰‡ -->
    <div id="loginCard" class="card login-wrap">
      <h2 class="center" style="margin:6px 0 14px">ç™»å½•</h2>
      <div class="grid">
        <div>
          <label>å¯†ç ï¼ˆå·²ä¸ºä½ é¢„è®¾ï¼‰</label>
          <input id="pwd" type="password" placeholder="è¯·è¾“å…¥å¯†ç ï¼Œä¾‹å¦‚ sk2025">
          <div class="muted">æç¤ºï¼šæœ¬åœ°æ ¡éªŒï¼Œä»…åœ¨ä½ çš„æµè§ˆå™¨å†…è¿›è¡Œã€‚</div>
        </div>
        <div class="row" style="justify-content:space-between">
          <button class="btn btn-primary" id="loginBtn">ç™»å½•</button>
          <div class="muted">é»˜è®¤å¯†ç ï¼š<code>sk2025</code></div>
        </div>
      </div>
    </div>

    <!-- åå°ä¸»ç•Œé¢ -->
    <div id="app" class="card hidden">
      <div class="tabs">
        <div id="tabEdit" class="tab active">âœï¸ ç¼–è¾‘ç°æœ‰äº§å“</div>
        <div id="tabCreate" class="tab">ğŸ†• æ–°å»ºäº§å“</div>
      </div>

      <!-- ç¼–è¾‘ç°æœ‰äº§å“ -->
      <section id="panelEdit">
        <div class="grid grid-cols-2">
          <div>
            <label>é€‰æ‹©äº§å“æ–‡ä»¶ï¼ˆè‡ªåŠ¨ä» <code>products.html</code> è§£æï¼‰</label>
            <div class="row">
              <select id="productSelect"></select>
              <button class="btn btn-ghost" id="refreshList">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div class="note" style="margin-top:8px">
              è‹¥åˆ—è¡¨ä¸ºç©ºï¼Œè¯·ç¡®ä¿ <code>products.html</code> ä¸­çš„äº§å“é“¾æ¥ä½¿ç”¨
              <code>href="products/xxx.html"</code> æˆ– <code>href="/products/xxx.html"</code>ã€‚
            </div>
            <div class="hr"></div>
            <div class="row">
              <button class="btn btn-primary" id="loadBtn">åŠ è½½åˆ°ç¼–è¾‘å™¨</button>
              <span class="badge" id="loadedTip" style="display:none">å·²åŠ è½½</span>
            </div>
          </div>
          <div>
            <label>å½“å‰æ–‡ä»¶å</label>
            <input id="currentFile" type="text" readonly>
            <div class="muted">ä½ å¯ä»¥ç›´æ¥ç¼–è¾‘ä¸‹æ–¹æºç ï¼Œç„¶åä¸‹è½½è¦†ç›–åŸæ–‡ä»¶ã€‚</div>
          </div>
        </div>

        <div class="hr"></div>

        <label>HTML æºç ç¼–è¾‘å™¨</label>
        <textarea id="editor" placeholder="è¿™é‡Œå°†æ˜¾ç¤ºäº§å“ HTML æºç â€¦â€¦"></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="downloadEdited">ä¸‹è½½ä¿®æ”¹åçš„æ–‡ä»¶</button>
          <button class="btn btn-ghost" id="copyName">å¤åˆ¶æ–‡ä»¶å</button>
          <button class="btn btn-danger" id="clearEditor">æ¸…ç©ºç¼–è¾‘å™¨</button>
        </div>
        <div class="muted" style="margin-top:6px">
          ä½¿ç”¨æ–¹æ³•ï¼šä¸‹è½½ååˆ° GitHub è¦†ç›–åŒåæ–‡ä»¶ï¼ˆè·¯å¾„ï¼š<code>/products/æ–‡ä»¶å.html</code>ï¼‰ã€‚Vercel ä¼šè‡ªåŠ¨å‘å¸ƒã€‚
        </div>
      </section>

      <!-- æ–°å»ºäº§å“ -->
      <section id="panelCreate" class="hidden">
        <div class="grid grid-cols-2">
          <div>
            <label>äº§å“æ ‡é¢˜ï¼ˆè‹±æ–‡æˆ–æ‹¼éŸ³ï¼Œå½±å“ SEOï¼‰</label>
            <input id="newTitle" type="text" placeholder="ä¾‹å¦‚ï¼šTropical Bikini">
          </div>
          <div>
            <label>æ–‡ä»¶åï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œå¯æ‰‹åŠ¨å¾®è°ƒï¼‰</label>
            <input id="newSlug" type="text" placeholder="tropical-bikini">
          </div>
          <div>
            <label>ä»·æ ¼ï¼ˆå¯é€‰ï¼‰</label>
            <input id="newPrice" type="text" placeholder="ä¾‹å¦‚ï¼š29.99">
          </div>
          <div>
            <label>ä¸»å›¾æ–‡ä»¶åï¼ˆä½ å°†æŠŠå›¾ç‰‡æ”¾åˆ° <code>/assets/uploads</code>ï¼‰</label>
            <input id="newImage" type="text" placeholder="ä¾‹å¦‚ï¼štropical-01.jpg">
          </div>
          <div class="grid" style="grid-template-columns:1fr">
            <label>äº§å“æè¿°ï¼ˆæ”¯æŒæ¢è¡Œï¼‰</label>
            <textarea id="newDesc" style="min-height:160px" placeholder="æè¿°å†…å®¹â€¦â€¦"></textarea>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn btn-primary" id="genBtn">ç”Ÿæˆäº§å“é¡µé¢</button>
          <button class="btn btn-ghost" id="previewBtn">é¢„è§ˆ HTML</button>
        </div>

        <div class="hr"></div>

        <label>ç”Ÿæˆç»“æœï¼ˆåªè¯»é¢„è§ˆï¼Œå¯ç›´æ¥ä¸‹è½½ï¼‰</label>
        <textarea id="genOutput" readonly placeholder="ç‚¹å‡»ã€ç”Ÿæˆäº§å“é¡µé¢ã€‘ååœ¨æ­¤æ˜¾ç¤ºæºç â€¦â€¦"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn btn-primary" id="downloadNew">ä¸‹è½½æ–°äº§å“æ–‡ä»¶</button>
        </div>
        <div class="muted" style="margin-top:6px">
          ä¸‹è½½åçš„æ–‡ä»¶è·¯å¾„å»ºè®®ä¸ºï¼š<code>/products/&lt;æ–‡ä»¶å&gt;.html</code>ï¼›ä¸»å›¾è¯·ä¸Šä¼ åˆ° <code>/assets/uploads</code>ã€‚
        </div>
      </section>
    </div>
  </div>

  <script>
    // ====== ç™»å½• ======
    const loginCard = document.getElementById('loginCard');
    const app = document.getElementById('app');
    const loginBtn = document.getElementById('loginBtn');
    const pwdInput = document.getElementById('pwd');
    const PASSWORD = 'sk2025';

    loginBtn.addEventListener('click', () => {
      const ok = pwdInput.value.trim() === PASSWORD;
      if (!ok) { alert('å¯†ç é”™è¯¯'); return; }
      loginCard.classList.add('hidden');
      app.classList.remove('hidden');
      // è‡ªåŠ¨åŠ è½½äº§å“åˆ—è¡¨
      loadProductList();
    });

    // Enter æäº¤
    pwdInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    // ====== Tab åˆ‡æ¢ ======
    const tabEdit = document.getElementById('tabEdit');
    const tabCreate = document.getElementById('tabCreate');
    const panelEdit = document.getElementById('panelEdit');
    const panelCreate = document.getElementById('panelCreate');

    function activate(tab) {
      if (tab === 'edit') {
        tabEdit.classList.add('active'); tabCreate.classList.remove('active');
        panelEdit.classList.remove('hidden'); panelCreate.classList.add('hidden');
      } else {
        tabCreate.classList.add('active'); tabEdit.classList.remove('active');
        panelCreate.classList.remove('hidden'); panelEdit.classList.add('hidden');
      }
    }
    tabEdit.addEventListener('click', ()=>activate('edit'));
    tabCreate.addEventListener('click', ()=>activate('create'));

    // ====== å·¥å…·å‡½æ•° ======
    const $ = (id)=>document.getElementById(id);
    function slugify(str){
      return str.toLowerCase()
        .replace(/[\u4e00-\u9fa5]/g,'')        // å»ä¸­æ–‡ï¼ˆå¯æŒ‰éœ€ä¿ç•™ï¼‰
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .replace(/--+/g,'-');
    }
    function downloadAsFile(filename, content){
      const blob = new Blob([content], {type:'text/html;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    // ====== ç¼–è¾‘ç°æœ‰äº§å“ï¼šåˆ—å‡º & åŠ è½½ ======
    const productSelect = $('productSelect');
    const refreshListBtn = $('refreshList');
    const loadBtn = $('loadBtn');
    const loadedTip = $('loadedTip');
    const currentFile = $('currentFile');
    const editor = $('editor');
    const copyName = $('copyName');
    const clearEditor = $('clearEditor');
    const downloadEdited = $('downloadEdited');

    async function loadProductList(){
      try{
        productSelect.innerHTML = '<option value="">ï¼ˆæ­£åœ¨è§£æ products.html â€¦ï¼‰</option>';
        // æ‹‰å– /products.html å¹¶è§£æå…¶ä¸­æŒ‡å‘ /products/*.html çš„é“¾æ¥
        const res = await fetch('/products.html', {cache:'no-store'});
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const anchors = Array.from(doc.querySelectorAll('a[href]'));
        const hrefs = anchors
          .map(a => a.getAttribute('href'))
          .filter(href => href && (/^\/?products\/.+\.html$/i).test(href))
          .map(href => href.startsWith('/') ? href : '/'+href);

        const uniq = Array.from(new Set(hrefs)).sort();
        if (uniq.length === 0) {
          productSelect.innerHTML = '<option value="">ï¼ˆæœªè§£æåˆ°äº§å“é“¾æ¥ï¼‰</option>';
          return;
        }
        productSelect.innerHTML = uniq.map(h=>`<option value="${h}">${h.replace('/products/','')}</option>`).join('');
      }catch(err){
        console.error(err);
        productSelect.innerHTML = '<option value="">ï¼ˆè§£æå¤±è´¥ï¼šè¯·æ£€æŸ¥ products.htmlï¼‰</option>';
      }
    }
    refreshListBtn.addEventListener('click', loadProductList);

    loadBtn.addEventListener('click', async ()=>{
      const sel = productSelect.value;
      if (!sel) { alert('è¯·å…ˆé€‰æ‹©äº§å“æ–‡ä»¶'); return; }
      try{
        const res = await fetch(sel, {cache:'no-store'});
        if (!res.ok) throw new Error('æ— æ³•åŠ è½½è¯¥æ–‡ä»¶');
        const text = await res.text();
        editor.value = text;
        currentFile.value = sel.replace('/products/','');
        loadedTip.style.display = 'inline-block';
        setTimeout(()=>loadedTip.style.display='none', 1800);
      }catch(e){
        alert('åŠ è½½å¤±è´¥ï¼š' + e.message);
      }
    });

    copyName.addEventListener('click', ()=>{
      if (!currentFile.value) return;
      navigator.clipboard.writeText(currentFile.value);
      alert('å·²å¤åˆ¶æ–‡ä»¶åï¼š' + currentFile.value);
    });
    clearEditor.addEventListener('click', ()=>{ editor.value=''; });

    downloadEdited.addEventListener('click', ()=>{
      const name = currentFile.value || 'edited-product.html';
      if (!editor.value.trim()) { alert('ç¼–è¾‘å™¨ä¸ºç©º'); return; }
      downloadAsFile(name, editor.value);
    });

    // ====== æ–°å»ºäº§å“ï¼šç”Ÿæˆæ¨¡æ¿ ======
    const newTitle = $('newTitle');
    const newSlug = $('newSlug');
    const newPrice = $('newPrice');
    const newImage = $('newImage');
    const newDesc = $('newDesc');
    const genBtn = $('genBtn');
    const previewBtn = $('previewBtn');
    const genOutput = $('genOutput');
    const downloadNew = $('downloadNew');

    newTitle.addEventListener('input', ()=>{
      if (!newSlug.dataset.touched){ newSlug.value = slugify(newTitle.value); }
    });
    newSlug.addEventListener('input', ()=>{ newSlug.dataset.touched = '1'; });

    function buildProductHtml({title, slug, price, imageFile, desc}){
      const priceHtml = price ? `<p class="price" style="font-weight:700;font-size:18px;margin:8px 0">$${price}</p>` : '';
      const safeTitle = title || 'New Product';
      const safeDesc = (desc || '').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
      const imgPath = imageFile ? `../assets/uploads/${imageFile}` : `../assets/uploads/placeholder.jpg`;

      // æ¨¡æ¿ï¼šç»Ÿä¸€ä½¿ç”¨ä½ ç«™ç‚¹ç°æœ‰æ ·å¼ï¼Œå¼•ç”¨ ../style.cssï¼Œå¹¶ä¿ç•™åŸºç¡€ç»“æ„ï¼ˆå¯æŒ‰éœ€æ‰©ï¼‰
      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${safeTitle} â€“ SwimShark</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../style.css">
  <style>
    .product-wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .product-hero{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .product-hero img{width:100%;height:auto;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .product-info h1{margin:0 0 8px;font-size:28px}
    .product-desc{color:#444;line-height:1.7}
    .back-link{display:inline-block;margin:10px 0 0;color:#2563eb;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="nav">
      <a href="../index.html" class="logo">SwimShark</a>
      <div class="nav-links">
        <a href="../products.html">Products</a>
        <a href="../about.html">About</a>
        <a href="../contact.html">Contact</a>
      </div>
    </nav>
  </header>

  <main class="product-wrap">
    <a class="back-link" href="../products.html">â† Back to Products</a>
    <div class="product-hero" style="margin-top:10px">
      <div><img src="${imgPath}" alt="${safeTitle}"></div>
      <div class="product-info">
        <h1>${safeTitle}</h1>
        ${priceHtml}
        <div class="product-desc">${safeDesc || ''}</div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <p>Â© ${new Date().getFullYear()} SwimShark. All rights reserved.</p>
    </div>
  </footer>
</body>
</html>`;
    }

    function ensureSlug(val){
      const s = (val||'').trim();
      return s ? slugify(s) : 'new-product';
    }

    genBtn.addEventListener('click', ()=>{
      const data = {
        title: newTitle.value.trim(),
        slug: ensureSlug(newSlug.value),
        price: (newPrice.value||'').trim(),
        imageFile: (newImage.value||'').trim(),
        desc: newDesc.value
      };
      const html = buildProductHtml(data);
      genOutput.value = html;
      alert('å·²ç”Ÿæˆäº§å“é¡µé¢æºç ï¼Œè¯·åœ¨ä¸‹æ–¹ç‚¹å‡»â€œä¸‹è½½æ–°äº§å“æ–‡ä»¶â€ã€‚');
    });

    previewBtn.addEventListener('click', ()=>{
      if (!genOutput.value.trim()) { genBtn.click(); }
      const blob = new Blob([genOutput.value], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(()=>URL.revokeObjectURL(url), 60000);
    });

    downloadNew.addEventListener('click', ()=>{
      if (!genOutput.value.trim()) { alert('è¯·å…ˆç”Ÿæˆäº§å“é¡µé¢'); return; }
      const name = ensureSlug(newSlug.value) + '.html';
      downloadAsFile(name, genOutput.value);
    });
  </script>
</body>
</html>
